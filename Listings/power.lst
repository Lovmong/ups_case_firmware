C51 COMPILER V9.60.7.0   POWER                                                             09/05/2023 11:52:52 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE POWER
OBJECT MODULE PLACED IN .\Objects\power.obj
COMPILER INVOKED BY: G:\Keil_v5_c51v961\C51\BIN\C51.EXE src\power.c OPTIMIZE(8,SPEED) INCDIR(.\src;.\system) PRINT(.\Lis
                    -tings\power.lst) TABS(2) OBJECT(.\Objects\power.obj)

line level    source

   1          #include "power.h"
   2          
   3          /* ----- 电源管理相关io初始化 -----
   4          
   5          
   6          */
   7          void PowerIoInit() {
   8   1          // output 推挽输出
   9   1          P3M0 |= 0x10; P3M1 &= ~0x10; // EN, P3.4 推挽输出
  10   1          P3M0 |= 0x40; P3M1 &= ~0x40; // PWR, P3.6 推挽输出
  11   1          // input 高阻输入
  12   1          P1M0 &= ~0x80; P1M1 |= 0x80; // ALWAYS_ON, P1.7 高阻输入
  13   1          P5M0 &= ~0x10; P5M1 |= 0x10; // RPI_STATE, P5.4 高阻输入 
  14   1          P3M0 &= ~0x08; P3M1 |= 0x08; // CHG, P3.3 高阻输入
  15   1          P3M0 &= ~0x20; P3M1 |= 0x20; // Power_Source, P3.5 高阻输入
  16   1          // ADC
  17   1          P3M0 &= ~0x01; P3M1 |= 0x01; // OUTPUT_CURRENT, P3.0 高阻输入
  18   1          P3M0 &= ~0x02; P3M1 |= 0x02; // BATTERY_CURRENT, P3.1 高阻输入
  19   1      
  20   1      }
  21          
  22          /* ---- 维持电池给单片机供电 ---- 
  23          PWR  维持高电平
  24          
  25          */
  26          void PowerInHold() {
  27   1          P3M0 |= 0x40; P3M1 &= ~0x40; // PWR, P3.6 推挽输出
  28   1          PWR = 1; // 维持高电平， 维持给单片机供电
  29   1      }
  30          
  31          
  32          /* ---- 输出5v ---
  33          
  34          */
  35          void PowerOutOpen() {
  36   1          P3M0 |= 0x10; P3M1 &= ~0x10; // EN, P3.4 推挽输出
  37   1          EN = 1;
  38   1      }
  39          
  40          
  41          void PowerOutClose() {
  42   1          P3M0 |= 0x10; P3M1 &= ~0x10; // EN, P3.4 推挽输出
  43   1          EN = 0;
  44   1      }
  45          
  46          /* ----- 上电时电源输出 -----
  47          当 ALWAYS_ON 为有效时（低电平）时，power 输出(),
  48          否则：
  49              读取eeprom值
  50              如果值为 0x01，power不输出
  51              如果值为 0x02，power不输出
  52              如果值错误，默认power不输出，写入 0x01
  53          */
  54          void PowerManagerAtStart() {
C51 COMPILER V9.60.7.0   POWER                                                             09/05/2023 11:52:52 PAGE 2   

  55   1          char stat = 0;
  56   1          
  57   1          P1M0 |= 0x80; P1M1 &= ~0x80; // ALWAYS_ON, P1.7 高阻输入
  58   1          P3M0 |= 0x10; P3M1 &= ~0x10; // EN, P3.4 推挽输出 
  59   1      
  60   1          if (ALWAYS_ON == 0) {
  61   2              delayUs(500); // 消抖
  62   2              if (ALWAYS_ON == 0) {
  63   3                  EN = 1; // power输出
  64   3                  return;
  65   3              }
  66   2          }
  67   1      
  68   1          stat = IapRead(POWER_MEMORY_ADDR);
  69   1          // EEPROM 的写操作只能将字节中的 1 写为 0，当需要将字节中的 0 写为 1，则必
             -执行扇区 擦除操作。
  70   1          switch (stat) {
  71   2              case 0x01: // 关闭输出
  72   2                  EN = 0;
  73   2                  break;
  74   2              case 0x02: // 开启输出
  75   2                  EN = 1;
  76   2                  break;
  77   2              default: // 默认power不输出，写入 0x01
  78   2                  EN = 0;
  79   2                  IapErase(POWER_MEMORY_ADDR);
  80   2                  IapProgram(POWER_MEMORY_ADDR, 0x01);
  81   2                  break;
  82   2          }
  83   1      
  84   1      }
  85          
  86          /* ----- 低电量时 -----
  87          
  88          */
  89          void PowerManagerInLowBattery() {
  90   1      
  91   1      }
  92          
  93          /* ----- 充电管理 ----- 
  94          
  95          */
  96          void ChargeManager() {
  97   1      
  98   1      }
  99          
 100          /* ----- 电源数据读取 -----
 101          
 102          */
 103          void PowerMonitor() {
 104   1      
 105   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    155    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----       1
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
C51 COMPILER V9.60.7.0   POWER                                                             09/05/2023 11:52:52 PAGE 3   

END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
