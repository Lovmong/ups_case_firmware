C51 COMPILER V9.60.7.0   FAN                                                               09/05/2023 17:56:58 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE FAN
OBJECT MODULE PLACED IN .\Objects\fan.obj
COMPILER INVOKED BY: G:\Keil_v5_c51v961\C51\BIN\C51.EXE src\fan.c OPTIMIZE(8,SPEED) INCDIR(.\src;.\system) PRINT(.\Listi
                    -ngs\fan.lst) TABS(2) OBJECT(.\Objects\fan.obj)

line level    source

   1          #include "fan.h"
   2          
   3          
   4          /* ----------------------------------------------------------------
   5          PWMx_ENO : 输出使能寄存器
   6          PWMA_ENO 
   7                7     6     5     4     3     2     1     0
   8              ENO4N ENO4P ENO3N ENO3P ENO2N ENO2P ENO1N ENO1P
   9          PWMB_ENO 
  10                7     6     5     4     3     2     1     0
  11                -    ENO8P  -    ENO7P  -    ENO6P  -   ENO5P
  12          
  13          输出附加使能寄存器（PWMx_IOAUX）
  14          
  15          控制寄存器 1（PWMx_CR1）
  16          PWMA_CR1
  17                  7     6   5    4   3     2    1    0
  18               ARPEA CMSA[1:0] DIRA OPMA URSA UDISA CENA
  19          PWMB_CR1
  20                  7     6   5    4   3     2    1    0
  21               ARPEB CMSB[1:0] DIRB OPMB URSB UDISB CENB
  22          
  23          控制寄存器 2（PWMx_CR2）
  24          从模式控制寄存器(PWMx_SMCR)
  25          外部触发寄存器(PWMx_ETR)
  26          中断使能寄存器(PWMx_IER)
  27          状态寄存器 1(PWMx_SR1)
  28          状态寄存器 2(PWMx_SR2)
  29          事件产生寄存器（PWMx_EGR）
  30          捕获/比较模式寄存器 1（PWMx_CCMR1）
  31          捕获/比较模式寄存器 2（PWMx_CCMR2）
  32          捕获/比较模式寄存器 3（PWMx_CCMR3）
  33          捕获/比较模式寄存器 4（PWMx_CCMR4）
  34          捕获/比较使能寄存器 1（PWMx_CCER1）
  35          捕获/比较使能寄存器 2（PWMx_CCER2）
  36          计数器高 8 位（PWMx_CNTRH）
  37          计数器低 8 位（PWMx_CNTRL）
  38          预分频器高 8 位（PWMx_PSCRH）
  39          预分频器低 8 位（PWMx_PSCRL）
  40          自动重装载寄存器高 8 位（PWMx_ARRH）
  41          自动重装载寄存器低 8 位（PWMx_ARRL）
  42          重复计数器寄存器（PWMx_RCR）
  43          捕获/比较寄存器 1/5 高 8 位（PWMx_CCR1H）
  44          捕获/比较寄存器 1/5 低 8 位（PWMx_CCR1L）
  45          捕获/比较寄存器 2/6 高 8 位（PWMx_CCR2H）
  46          捕获/比较寄存器 2/6 低 8 位（PWMx_CCR2L）
  47          捕获/比较寄存器 3/7 高 8 位（PWMx_CCR3H）
  48          捕获/比较寄存器 3/7 低 8 位（PWMx_CCR3L）
  49          捕获/比较寄存器 4/8 高 8 位（PWMx_CCR4H）
  50          捕获/比较寄存器 4/8 低 8 位（PWMx_CCR4L）
  51          刹车寄存器（PWMx_BKR）
  52          死区寄存器（PWMx_DTR）
  53          输出空闲状态寄存器（PWMx_OISR）
  54          ---------------------------------------------------------------- */
C51 COMPILER V9.60.7.0   FAN                                                               09/05/2023 17:56:58 PAGE 2   

  55          void fanInit() {
  56   1          // P1M0 |= 0x01; P1M1 &= ~0x01;  // P1.0 推挽输出
  57   1          P1M0 &= ~0x01; P1M1 &= ~0x01; // P1.0 准双向口
  58   1          P1M0 &= ~0x04; P1M1 &= ~0x04; 
  59   1      
  60   1          // P1.0 PWM1P
  61   1      #if USE_PWM
  62   1          P_SW2 |= 0x80;  //扩展寄存器(XFR)访问使能
  63   1      
  64   1          PWMA_CCER1 = 0x00;                          //写CCMRx前必须先清零CCERx关闭通道
  65   1          PWMA_CCMR1 = 0x68;                          //设置CC1为PWMA输出模式 1, 使能预装载功能
  66   1          // PWMA_CCER1 = 0x01;                          //使能CC1通道
  67   1          // PWMA_CCER1 = 0x55;                          //使能CC1通道
  68   1          PWMA_CCMR2 = 0x68;
  69   1          PWMA_CCER1 = 0x31;                          //使能CC1, CC2通道
  70   1      
  71   1          // pwm频率 = 系统时钟/（（预分频+1）/ （自动重装载值arr+1））= 12MHz / 12 / 20,00
             -0 = 50Hz
  72   1          // pwm频率 = 系统时钟/（（预分频+1）/ （自动重装载值arr+1））= 12MHz / 2 / 240 = 
             -25KHz
  73   1          PWMA_PSCRH = (u8)((PWM_PSCR-1) >> 8); // 设置预分频
  74   1          PWMA_PSCRL = (u8)(PWM_PSCR-1);
  75   1          PWMA_ARRH = (u8)((PWM_PERIOD-1) >> 8); //设置周期时间， PWMA_ARR自动重装值
  76   1          PWMA_ARRL = (u8)(PWM_PERIOD-1);
  77   1      
  78   1          PWMA_CCR1H = (u8)(0 >> 8);         //设置占空比时间
  79   1          PWMA_CCR1L = (u8)(0);
  80   1      
  81   1          PWMA_CCR2H = (u8)(0 >> 8);         //设置占空比时间
  82   1          PWMA_CCR2L = (u8)(0);
  83   1      
  84   1          PWMA_ENO |= 0x01;                              //使能PWM1P端口输出
  85   1          PWMA_ENO |= 0x04;                              //使能PWM2P端口输出
  86   1      
  87   1          // PWMA_IOAUX &= ~0x01;                           // PWM1P 的输出直接由 ENO1P 控制
  88   1      
  89   1          PWMA_BKR = 0x80;                            //使能主输出
  90   1          PWMA_CR1 = 0x01;                            //使能计数器，开始计时
  91   1      #endif
  92   1      } 
  93          
  94          
  95          void fanSetSpeed(u8 speed) {
  96   1      #if USE_PWM
  97   1          u16 ccr = 0;
  98   1          ccr = ((u32)PWM_PERIOD * speed/100);
  99   1          P_SW2 |= 0x80;
 100   1          // 更新占空比
 101   1          PWMA_CCR1H = (u8)(ccr >> 8);
 102   1          PWMA_CCR1L = (u8)(ccr);
 103   1      
 104   1          PWMA_CCR2H = (u8)(ccr >> 8);
 105   1          PWMA_CCR2L = (u8)(ccr);
 106   1      #else
                  if (speed == 0) FAN = 0;
                  else FAN = 1;
              #endif
 110   1      }
 111          
 112          
 113          

C51 COMPILER V9.60.7.0   FAN                                                               09/05/2023 17:56:58 PAGE 3   


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    128    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
